{% extends "base.html" %}

{% block head %}
{% endblock %}

{% block content %}
<div class="row">
    <!-- File Browser -->
    <div class="col-3">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button id="up-button" class="btn btn-sm btn-secondary me-2" onclick="navigateUp()" disabled>
                            <i class="bi bi-arrow-up"></i>
                        </button>
                        File Explorer
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="openFolder()">
                        Open Folder
                    </button>
                </div>
                <div id="current-path" class="small text-muted mt-1"></div>
            </div>
            <div class="card-body" id="file-browser">
                <div id="browser-content">
                    <!-- File list will be loaded here -->
                </div>
                <div id="browser-error" class="alert alert-danger d-none">
                    <!-- Errors will be shown here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Plot Area -->
    <div class="col-9">
        <div class="card">
            <div class="card-header">
                <!-- Tab navigation -->
                <div class="d-flex justify-content-between align-items-center">
                    <ul class="nav nav-tabs card-header-tabs mb-0" id="plot-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tab-1" data-bs-toggle="tab" data-bs-target="#plot-1" type="button" role="tab">
                                Plot 1
                                <span class="ms-2 close-tab">&times;</span>
                            </button>
                        </li>
                    </ul>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="splitPlot()">
                            <i class="bi bi-layout-split"></i> Split
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="combinePlot()">
                            <i class="bi bi-layout-join"></i> Combine
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Tab content -->
                <div class="tab-content" id="plot-tabs-content">
                    <div class="tab-pane fade show active" id="plot-1" role="tabpanel">
                        <div class="plot-container" id="plot-container">
                            <!-- Plot will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden file input -->
<input type="file" id="folder-input" webkitdirectory directory style="display: none">

<!-- Context Menu -->
<div id="context-menu" class="position-fixed bg-white border rounded shadow p-2" style="display: none; z-index: 1000;">
    <div class="context-menu-item" data-action="replace">
        <i class="bi bi-arrow-repeat me-2"></i>Replace
    </div>
    <div class="context-menu-item" data-action="append">
        <i class="bi bi-plus-circle me-2"></i>Append
    </div>
    <div class="context-menu-item" data-action="new-tab">
        <i class="bi bi-plus-square me-2"></i>New Tab
    </div>
</div>

<style>
    .context-menu-item {
        cursor: pointer;
        padding: 0.5rem 1rem;
        white-space: nowrap;
    }

    .context-menu-item:hover {
        background-color: #f8f9fa;
    }

    .signal-selected {
        background-color: #e9ecef;
    }

    .close-tab {
        cursor: pointer;
        opacity: 0.5;
    }

    .close-tab:hover {
        opacity: 1;
    }

    .nav-link .close-tab {
        display: inline;
    }

    .nav-link:not(:only-child) .close-tab {
        display: inline;
    }

    .signal-representation .dropdown-menu {
        min-width: 120px;
    }

    .signal-representation .btn:hover,
    .signal-representation .btn:focus {
        opacity: 0.7;
    }

    .badge {
        font-size: 0.7em;
    }

    .signal-representation .btn {
        color: var(--bs-primary);
    }

    .signal-representation .text-muted {
        opacity: 0.5;
        cursor: default;
    }

    .signal-representation .dropdown-menu .math {
        font-size: 1.2em;
        padding: 0 0.5em;
    }

    .signal-representation .btn .math {
        font-size: 1.1em;
        color: var(--bs-primary);
    }

    .signal-representation .text-muted .math {
        opacity: 0.5;
        cursor: default;
    }

    .signal-representation .math {
        font-family: "Times New Roman", serif;
        font-size: 1.2em;
        padding: 0 0.5em;
    }
</style>

<script>
let currentPath = '';

function navigateUp() {
    if (currentPath) {
        fetch(`/browse/${currentPath}`)
            .then(response => response.json())
            .then(data => {
                if (data.parent_path !== null) {
                    loadDirectory(data.parent_path);
                } else {
                    loadDirectory('');
                }
            });
    }
}

function loadDirectory(path='') {
    const browserContent = document.getElementById('browser-content');
    const browserError = document.getElementById('browser-error');
    const upButton = document.getElementById('up-button');
    const currentPathElement = document.getElementById('current-path');

    // Update current path
    currentPath = path;

    // Show loading state
    browserContent.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
    browserError.classList.add('d-none');

    fetch(`/browse/${path}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Enable/disable up button
            upButton.disabled = data.is_root;

            // Show current path
            currentPathElement.textContent = data.current_path || '/';

            // Update file list
            browserContent.innerHTML = data.items.map(item => `
                <div class="d-flex align-items-center p-2 border-bottom"
                     data-path="${item.path}"
                     data-type="${item.type}"
                     data-ndim="${item.ndim || ''}"
                     data-is-complex="${item.is_complex || false}"
                     style="cursor: pointer">
                    <i class="bi ${item.type === 'signal' ? 'bi-graph-up' : 'bi-folder'} me-2"></i>
                    <span>${item.name}</span>
                    ${item.type === 'signal' ? `
                        <div class="ms-auto d-flex align-items-center">
                            <span class="badge bg-secondary me-2">${item.ndim}D</span>
                            <div class="signal-representation">
                                ${item.is_complex ? `
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-link p-0 me-2" type="button" data-bs-toggle="dropdown">
                                            <span class="math">ℜ</span>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" data-representation="real" data-symbol="ℜ">
                                                <span class="math">ℜ</span>
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" data-representation="imaginary" data-symbol="ℑ">
                                                <span class="math">ℑ</span>
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" data-representation="magnitude" data-symbol="∥z∥">
                                                <span class="math">∥z∥</span>
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" data-representation="phase" data-symbol="∠z">
                                                <span class="math">∠z</span>
                                            </a></li>
                                        </ul>
                                    </div>
                                ` : `
                                    <span class="math text-muted">ℜ</span>
                                `}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');

            // Add click handlers
            browserContent.querySelectorAll('[data-path]').forEach(el => {
                el.addEventListener('click', (event) => {
                    if (el.dataset.type === 'folder') {
                        loadDirectory(el.dataset.path);
                    } else {
                        // Just select the signal
                        selectSignal(el);
                    }
                });

                // Add right-click handler for signals
                if (el.dataset.type === 'signal') {
                    el.addEventListener('contextmenu', (event) => {
                        showContextMenu(event, el);
                    });
                }
            });

            // After setting innerHTML, trigger MathJax
            if (window.MathJax) {
                MathJax.typesetPromise().catch((err) => console.log('MathJax error:', err));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            browserError.textContent = `Error loading directory: ${error.message}`;
            browserError.classList.remove('d-none');
        });
}

// Load initial directory
loadDirectory();

// Context menu handling
let contextMenuTarget = null;

function showContextMenu(event, element) {
    event.preventDefault();
    const contextMenu = document.getElementById('context-menu');
    contextMenu.style.display = 'block';
    contextMenu.style.left = `${event.pageX}px`;
    contextMenu.style.top = `${event.pageY}px`;
    contextMenuTarget = element;
}

function hideContextMenu() {
    const contextMenu = document.getElementById('context-menu');
    contextMenu.style.display = 'none';
    contextMenuTarget = null;
}

function selectSignal(element) {
    // Remove selection from other elements
    document.querySelectorAll('.signal-selected').forEach(el => {
        el.classList.remove('signal-selected');
    });
    // Add selection to clicked element
    element.classList.add('signal-selected');
}

function updatePlot(tabId) {
    return fetch(`/plot/update?tab_id=${tabId}`)
        .then(response => response.json())
        .then(data => {
            if (data.script && data.div) {
                const activeTab = document.getElementById(`plot-${tabId}`);
                const plotContainer = activeTab.querySelector('.plot-container');
                plotContainer.innerHTML = data.div;
                const scriptElement = document.createElement('script');
                scriptElement.type = 'text/javascript';
                scriptElement.text = data.script;
                document.body.appendChild(scriptElement);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(`Error plotting signal: ${error.message}`);
        });
}

// Add this function to handle tab closing
function closeTab(event) {
    event.stopPropagation();  // Prevent the tab from being activated
    const tabButton = event.target.closest('button');
    const tabId = tabButton.id.replace('tab-', '');
    const tabContent = document.getElementById(`plot-${tabId}`);
    const tabNav = tabButton.closest('.nav-item');

    // Call the close_tab endpoint
    fetch(`/plot/close_tab/${tabId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                // If this is the active tab, activate another tab
                if (tabButton.classList.contains('active')) {
                    // Try to activate the previous tab, or the next one if there is no previous
                    const nextTab = tabNav.nextElementSibling || tabNav.previousElementSibling;
                    if (nextTab) {
                        const nextButton = nextTab.querySelector('button');
                        nextButton.classList.add('active');
                        document.querySelector(nextButton.dataset.bsTarget).classList.add('active', 'show');
                    }
                }

                // Remove the tab and its content
                tabContent.remove();
                tabNav.remove();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(`Error closing tab: ${error.message}`);
        });
}

// Update the createNewTab function to add close handler
function createNewTab(tabId) {
    const tabsNav = document.getElementById('plot-tabs');
    const tabsContent = document.getElementById('plot-tabs-content');

    // Remove active class from current tabs
    tabsNav.querySelectorAll('.nav-link').forEach(tab => tab.classList.remove('active'));
    tabsContent.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
        pane.classList.remove('show');
    });

    // Create new tab button
    const newTab = document.createElement('li');
    newTab.className = 'nav-item';
    newTab.setAttribute('role', 'presentation');
    newTab.innerHTML = `
        <button class="nav-link active" id="tab-${tabId}" data-bs-toggle="tab"
                data-bs-target="#plot-${tabId}" type="button" role="tab">
            Plot ${tabId}
            <span class="ms-2 close-tab">&times;</span>
        </button>
    `;

    // Add close handler
    newTab.querySelector('.close-tab').addEventListener('click', closeTab);

    // Create new tab content
    const newContent = document.createElement('div');
    newContent.className = 'tab-pane fade show active';
    newContent.id = `plot-${tabId}`;
    newContent.setAttribute('role', 'tabpanel');
    newContent.innerHTML = `
        <div class="plot-container" id="plot-container-${tabId}">
            <!-- Plot will be inserted here -->
        </div>
    `;

    // Add new elements to DOM
    tabsNav.appendChild(newTab);
    tabsContent.appendChild(newContent);

    return tabId;
}

// Add close handler to initial tab
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.close-tab').forEach(closeButton => {
        closeButton.addEventListener('click', closeTab);
    });
});

// Add this function before plotSignal
function getActiveTabId() {
    const activeTab = document.querySelector('.tab-pane.active');
    return activeTab ? activeTab.id.replace('plot-', '') : '1';
}

function plotSignal(action, element) {
    const path = element.dataset.path;
    const representation = element.dataset.selectedRepresentation || 'real';
    let url = '';

    switch(action) {
        case 'replace':
            url = `/signal/replace/${path}?representation=${representation}`;
            break;
        case 'append':
            url = `/signal/append/${path}?representation=${representation}`;
            break;
        case 'new-tab':
            url = `/signal/new_tab/${path}?representation=${representation}`;
            break;
    }

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                if (data.tab_id) {
                    // If a new tab was created, switch to it
                    switchToTab(data.tab_id);
                }
                // Update the plot
                updatePlot(data.tab_id || getActiveTabId());
            } else {
                throw new Error(data.error || 'Unknown error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(`Error plotting signal: ${error.message}`);
        });
}

// Modify the context menu click handler
document.getElementById('context-menu').addEventListener('click', function(event) {
    const action = event.target.closest('.context-menu-item')?.dataset.action;
    if (action && contextMenuTarget) {
        plotSignal(action, contextMenuTarget);
        hideContextMenu();
    }
});

// Hide context menu when clicking outside
document.addEventListener('click', hideContextMenu);

// Open folder dialog
function openFolder() {
    const input = document.getElementById('folder-input');
    input.onchange = function() {
        if (this.files.length > 0) {
            // Get the parent directory of the first file
            const filePath = this.files[0].path;
            const folderPath = filePath.substring(0, filePath.lastIndexOf('/'));

            fetch('/set-root', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ path: folderPath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadDirectory();
                }
            });
        }
    };
    input.click();
}

function splitPlot() {
    const activeTab = document.querySelector('.tab-pane.active');
    const tabId = activeTab.id.replace('plot-', '');

    fetch(`/plot/split?tab_id=${tabId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updatePlot(tabId);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(`Error splitting plot: ${error.message}`);
        });
}

function combinePlot() {
    const activeTab = document.querySelector('.tab-pane.active');
    const tabId = activeTab.id.replace('plot-', '');

    fetch(`/plot/combine?tab_id=${tabId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updatePlot(tabId);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(`Error combining plot: ${error.message}`);
        });
}

// Update the representation selection handler
document.addEventListener('click', function(event) {
    if (event.target.matches('.signal-representation .dropdown-item') ||
        event.target.closest('.signal-representation .dropdown-item')) {
        event.preventDefault();
        const item = event.target.closest('.dropdown-item');
        const representation = item.dataset.representation;
        const symbol = item.dataset.symbol;
        const signalElement = item.closest('[data-path]');
        const button = signalElement.querySelector('.signal-representation button');

        // Update the symbol
        button.innerHTML = `<span class="math">${symbol}</span>`;

        // Store the selected representation in the element's data
        signalElement.dataset.selectedRepresentation = representation;
    }
});
</script>
{% endblock %}
